## 为什么很多站点第二次打开速度会很快？

HTTP协议是建立在TCP连接基础之上的.`HTTP是一种允许浏览器向服务器获取资源的协议，是web的基础。`通常由浏览器发起请求，用来获取不同类型的文件，HTML、CSS、JS文件等。
`HTTP协议是浏览器使用最广的协议`

## question??
1. 为什么通常在第一次访问一个站点时，打开速度很慢，当再次访问这个站点时，速度就很快了？
2. 当登录过一个网站之后，下次再访问该站点，就已经处于登录状态了，这是怎么做到的呢？

## 浏览器向服务器发起HTTP请求流程

1. 构建请求。
浏览器构建请求行信息，构建好后，浏览器准备发起网络请求。
```
GET /index.html HTTP1.1
```

2. 查找缓存
发起网络请求前，浏览器会在浏览器缓存中查询是否由要请求的文件。`浏览器缓存时一种在本地保存资源副本，一共下次请求直接使用的技术。`
好处：
- 缓解服务器压力，提升性能。
- 缓存时实现快速资源加载的重要组成部分。

3. 准备IP地址和端口
- HTTP和TCP之间的关系
HTTP协议：应用层协议，封装请求的文本信息；并使用TCP/IP作传输层协议将它发到网络上，所以在 HTTP 工作开始之前，浏览器需要通过 TCP 与服务器建立连接。
`HTTP协议是内容是通过TCP的传输数据阶段来实现的。`

数据包都是通过 IP 地址传输给接收方的。
所以基于这个需求又出现了一个服务，负责把域名和 IP 地址做一一映射关系。叫做`DNS数据缓存服务`

4. 等待TCP队列。
同一个域名最多能建立6个TCP连接。多则进入等待状态；少则进入下一步，建立TCP连接。
5. 建立TCP连接。
6. 发送HTTP请求。
浏览器向服务器发送`请求行`，包括：`请求方法、请求URI、HTTP版本协议`

## 服务端处理HTTP请求
1. 返回请求
```js
curl -i  https://time.geekbang.org/
```
返回响应行、响应头和响应体的数据
最常用的状态码是 200，表示处理成功；
如果没有找到页面，则会返回404。
2. 断开连接
通常情况下，一旦服务器向客户端返回了请求数据，它就要关闭 TCP 连接。不过如果浏览器或者服务器在其头信息中加入了：
```js
Connection:Keep-Alive 
```
`保持 TCP 连接可以省去下次请求时需要建立连接的时间，提升资源加载速度。`

3. 重定向
`两个 URL 之所以不一样，是因为涉及到了一个重定向操作`
```js
curl -I geekbang.org
```
-I表示只需要获取响应头和响应行数据，而不需要获取响应体的数据

响应行返回的状态码是 301，状态 301 就是告诉浏览器，我需要重定向到另外一个网址，而需要重定向的网址正是包含在响应头的 Location 字段中

## 问题解答
1. 为什么很多站点第二次打开速度会很快？
DNS 缓存和页面资源缓存这两块数据是会被浏览器缓存的。

`Cache-Control 字段来设置是否缓存该资源`
If-None-Match 的值来判断请求的资源是否有更新。

- 如果没有更新，就返回 304 状态码，相当于服务器告诉浏览器： “这个缓存可以继续使用，这次就不重复发送数据给你了。”
如果资源有更新，服务器就直接返回最新资源给浏览器。 

2. 登录状态是如何保持的？
- 字符串写到响应头的 Set-Cookie 字段里，如下所示，然后把响应头发送给浏览器。
- 如果遇到响应头里含有 Set-Cookie 字段的情况，浏览器就会把这个字段信息保存到本地