## 01 | Chrome架构：仅仅打开了一个页面，为什么会有4个进程？

- 那么多浏览器，为什么选择了Chrome浏览器？
1. 因为Chrome、微软Edge以及国内的大部分主流浏览器，都是基于Chromium的二次开发而来；
2. Chrome是Google的官方发行版，特性和Chromium基本一样，只存在一些产品层面的差异；
3. Chrome是目前世界上使用率最高的浏览器，所以Chrome最具代表性。

- 进程和线程

1. 什么是并行处理？
```js
A = 1 + 2
B = 20/5
C = 7*8
```
这里有4个任务：
前三个是计算结果，最后一个任务是显示计算结果。

如果采用多线程，会怎么样？
只需分两步走：第一步，使用三个线程同时执行前三个任务；第二步：再执行第四个显示任务。

因此`使用并行处理能大大提升性能`

- 线程VS进程
`线程是不能单独存在的，它是由进程来启动和管理的`

1. 什么是进程呢？
`一个进程就是一个程序运行的实例`。详细解释就是，启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样一个运行环境叫进程。

`线程依附于进程，而进程中使用多线程并行处理能提升运算效率。`

### 线程和进程之间的关系有四个特点
- 进程中的任一线程出错，会导致整个进程的崩溃。
- 线程之间共享进程的数据。
- 当一个进程关闭后，操作系统回收进程所占用的内存。
- 进程之间内容相互隔离。

### 单线程浏览器的时代

顾名思义：`单线程浏览器是指浏览器的所有功能模块都是运行在用一个进程里`，这些模块包含了网络、插件、js运行环境、渲染引擎和页面等。

如此多的模块运行在一个进程里，是导致浏览器`不稳定、不流畅、不安全`的一个主要因素。

- 不稳定
早期浏览器需要借助于插件来实现WEB视频、WEB游戏的强大功能，但是插件是最容易出现问题的模块，并且还运行在浏览器进程之中，所以一个插件的意外崩溃会引起整个浏览器的崩溃。
`渲染引擎模块`也是不稳定的，一些复杂的JS代码就会引起渲染引擎模板的崩溃。

- 不流畅
所有的模块、插件都运行在一个线程中，意味着同一时刻只有一个模块可以执行

存在
```js
function freeze() {
	while (1) {
		console.log("freeze");
	}
}
freeze();
```
这个脚本是无限循环的，当其执行时，会独占整个线程，导致其它运行在该线程的模块没有机会执行。回到是整个浏览器失去响应，变卡顿。

除了上述的`脚本`和`插件`会让单线程变卡顿外，`页面的内存泄露`也是单线程变慢的重要原因。浏览器的内核是非常复杂的，运行页面在关闭页面，会在内存不能完全回收的情况，纸样倒是的问题是使用时间越长，内存占用越高，浏览器会变得越慢。

- 不安全
通过插件可以完全操作你的电脑，如果是恶意插件，那么他就可以释放病毒、窃取账号密码、引发安全相问题。
至于页面脚本，可以通过浏览器的漏洞来获取系统权限，脚本获取权限后可以对电脑做一些恶意的事情。

### 多进程浏览器时代

- 如何解决不稳定的问题。
  进程间相互隔离，当一个页面崩溃时，影响的仅仅是当前页面的进程或者插件进程。
- 如何解决不流畅问题
  JS是运行在渲染进程中的，即使JS阻塞了渲染进程，影响到的也只是当前渲染页面，并不会影响到其他页面，其他页面的脚本使圆形在它们自己的渲染进程中。
  对于内存泄漏，关闭页面时整个渲染进程也会被关闭，之后该进程所占用的内存都会被系统回收。
- 两个安全问题怎么解决？
  采用多进程额外的好处是可以使用`安全沙箱`，可以看出把操作系统上了一把锁，沙箱里的程序可以运行，但是不能在硬盘上写u人任何数据，也不能在敏感位置读取任何数据，例如 你的文档和桌面。
  Chrome把插件进程和渲染进程锁在沙箱里面，这样集视渲染基础或者沙箱里面执行了恶意程序，恶意程序也无法突破沙箱去获取权限。

### 目前的多进程架构

最新的Chrome浏览器包括：1个浏览器主进程、一个GPU进程、一个网络进程、多个渲染进程和多个插件进程。

分析各个进程之间的功能：
- 浏览器进程：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。

- 渲染进程：核心任务是将HTML,CSS和JS转换为用户可以与之交互的网页，排版引擎Blink和JS引擎V8都是运行在该进程中，默认情况下，Chrome会为每个Tab标签常见一个渲染进程。处于安全考虑，渲染进程都是运行在沙箱模式下。

- GPU进程。Chrome的UI界面都是选择采用GPU来绘制，这使得GPU成为浏览器普遍的需求。

- 网络进程：负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面，最近才堵路出来，成为一个单独的进程。

- 插件进程：负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

讲到这里，应该知道：打开一个页面，为什么会有4个进程？

- 带来了一些问题
`更高的资源占用`。每个进程斗湖包含公告基础结构的副本，这就意味着会消耗更多的内存资源。

`更复杂的体系架构`。浏览器之间耦合性高、扩展性差等问题，会导致现在的架构很难适应新的需求了。

### 未来面向服务的架构(SOA)
原来的各个模块会重构成独立的服务，每个服务都将而已在独立的进程中运行，访问服务必须使用定义好的接口，通过IPC来通信，从而`构建一个更内聚、松耦合、易于维护和扩展的系统`